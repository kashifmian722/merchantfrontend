import { __decorate, __param } from "tslib";
/*
 * Copyright (c) 2016-2020 VMware, Inc. All Rights Reserved.
 * This software is released under MIT license.
 * The full license information can be found in LICENSE in the root directory of this project.
 */
import { PLATFORM_ID } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, NgZone, OnDestroy } from '@angular/core';
import { uniqueIdFactory } from '../id-generator/id-generator.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export var ClrAriaLivePoliteness;
(function (ClrAriaLivePoliteness) {
    ClrAriaLivePoliteness["off"] = "off";
    ClrAriaLivePoliteness["polite"] = "polite";
    ClrAriaLivePoliteness["assertive"] = "assertive";
})(ClrAriaLivePoliteness || (ClrAriaLivePoliteness = {}));
/**
 * Time in milliseconds before inserting the content into the container
 */
var ARIA_LIVE_TICK = 100;
/**
 * This service handle `aria-live` accessibility attribute. The issue is that you need
 * to have the DOM Element with attribute `aria-live` before you could insert content
 * and SR (Screen Reader) pick the change and announce it.
 *
 * ```typescript
 * import { ClrAriaLiveService } from 'src/clr-angular/utils/a11y/aria-live.service';
 *
 * @Component({
 * selector: 'clr-demo-component',
 * providers: [ClrAriaLiveService],
 * template: `
 *   <ng-content></ng-content>
 * `,
 * })
 * export class DemoComponent {
 *  constructor(ariaLiveService: ClrAriaLiveService) {}
 *
 *  public actionThatWillTriggerChange() {
 *    this.ariaLiveService.announce('message that I want to announce to SR');
 *  }
 * }
 * ```
 *
 */
var ClrAriaLiveService = /** @class */ (function () {
    function ClrAriaLiveService(ngZone, _document, platformId) {
        this.ngZone = ngZone;
        this.platformId = platformId;
        this._id = "clr-aria-live-element-" + uniqueIdFactory();
        this.document = _document;
    }
    Object.defineProperty(ClrAriaLiveService.prototype, "id", {
        /**
         * get access to the internal HTML `id` that gonna be used for the AriaLive container.
         * @return ID of the DOM Element as string.
         */
        get: function () {
            return this._id;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Append text content inside the AriaLive Container. This method will check if the
     * DOM Element is existing if not it will create one for us and the will apply the text.
     *
     * ```typescript
     * this.ariaLiveService.announce(this.el.nativeElement);
     * // or
     * this.ariaLiveService.announce('Message to announce to SR');
     * ```
     *
     * @remark
     * When second argument is `AriaLivePoliteness.off` we won't create aria container or update it.
     * The reason for that is that we don't want to do additional work if the SR will ignore it.
     *
     * @param message - This could be simple string or HTMLElement
     * @param politeness - 'polite', 'assertive' or 'off'
     */
    ClrAriaLiveService.prototype.announce = function (message, politeness) {
        var _this = this;
        if (politeness === void 0) { politeness = ClrAriaLivePoliteness.polite; }
        if (politeness === ClrAriaLivePoliteness.off) {
            return;
        }
        if (!this.ariaLiveElement && isPlatformBrowser(this.platformId)) {
            this.ariaLiveElement = this.createContainer();
        }
        message = typeof message !== 'string' && isPlatformBrowser(this.platformId) ? message.textContent : message;
        // when there is no message do NOTHING!
        if (!message) {
            return;
        }
        this.ariaLiveElement.setAttribute('aria-live', politeness);
        // This 100ms timeout is necessary for some browser + screen-reader combinations:
        // - Both JAWS and NVDA over IE11 will not announce anything without a non-zero timeout.
        // - With Chrome and IE11 with NVDA or JAWS, a repeated (identical) message won't be read a
        //   second time without clearing and then using a non-zero delay.
        // (using JAWS 17 at time of this writing).
        this.ngZone.runOutsideAngular(function () {
            // This clearTimeout will stop all older messages from announcing
            // in the case where the messages are comming too fast we gonna try to append only
            // the last one. That's what the SR will try to do anyway.
            clearTimeout(_this.previousTimeout);
            _this.previousTimeout = setTimeout(function () {
                _this.ariaLiveElement.textContent = message;
            }, ARIA_LIVE_TICK);
        });
    };
    /**
     * onDestroy life cycle - must stop all active setTimeouts and remove the AriaLive
     * container from the document.
     */
    ClrAriaLiveService.prototype.ngOnDestroy = function () {
        clearTimeout(this.previousTimeout);
        if (isPlatformBrowser(this.platformId) && this.ariaLiveElement) {
            this.document.body.removeChild(this.ariaLiveElement);
            this.ariaLiveElement = null;
        }
    };
    /**
     * Create AriaLive DOM element as a last child of the document.
     * After the element is created, we gonna apply Clarity class to hide it from
     * the screen and set the `aria-live` politness.
     *
     * `clr-sr-only` is the CSS class that is used to hide the element from the screen.
     *
     * @remark
     * Calling this method multiple times will create multiple DOM Elements, that
     * won't be tracked and will be GC after the service is destroyed.
     *
     * @return AriaLive container as HTMLElement
     *
     */
    ClrAriaLiveService.prototype.createContainer = function () {
        var ariaLiveElement = this.document.createElement('div');
        ariaLiveElement.setAttribute('id', this.id);
        // Use clarity screen reader class to hide the dom element
        // and fix the scrollbar shake
        ariaLiveElement.classList.add('clr-sr-only');
        ariaLiveElement.setAttribute('aria-atomic', 'true');
        ariaLiveElement.setAttribute('aria-live', ClrAriaLivePoliteness.polite);
        this.document.body.appendChild(ariaLiveElement);
        return ariaLiveElement;
    };
    ClrAriaLiveService.ctorParameters = function () { return [
        { type: NgZone },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
    ]; };
    ClrAriaLiveService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ClrAriaLiveService_Factory() { return new ClrAriaLiveService(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID)); }, token: ClrAriaLiveService, providedIn: "root" });
    ClrAriaLiveService = __decorate([
        Injectable({
            providedIn: 'root',
        }),
        __param(1, Inject(DOCUMENT)),
        __param(2, Inject(PLATFORM_ID))
    ], ClrAriaLiveService);
    return ClrAriaLiveService;
}());
export { ClrAriaLiveService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJpYS1saXZlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY2xyL2FuZ3VsYXIvIiwic291cmNlcyI6WyJ1dGlscy9hMTF5L2FyaWEtbGl2ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0NBQXNDLENBQUM7OztBQUV2RSxNQUFNLENBQU4sSUFBWSxxQkFJWDtBQUpELFdBQVkscUJBQXFCO0lBQy9CLG9DQUFXLENBQUE7SUFDWCwwQ0FBaUIsQ0FBQTtJQUNqQixnREFBdUIsQ0FBQTtBQUN6QixDQUFDLEVBSlcscUJBQXFCLEtBQXJCLHFCQUFxQixRQUloQztBQUVEOztHQUVHO0FBQ0gsSUFBTSxjQUFjLEdBQVcsR0FBRyxDQUFDO0FBRW5DOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F3Qkc7QUFJSDtJQUtFLDRCQUNVLE1BQWMsRUFDSixTQUFjLEVBQ0gsVUFBa0I7UUFGdkMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUVPLGVBQVUsR0FBVixVQUFVLENBQVE7UUFLekMsUUFBRyxHQUFXLDJCQUF5QixlQUFlLEVBQUksQ0FBQztRQUhqRSxJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQztJQUM1QixDQUFDO0lBT0Qsc0JBQVcsa0NBQUU7UUFKYjs7O1dBR0c7YUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUNsQixDQUFDOzs7T0FBQTtJQUVEOzs7Ozs7Ozs7Ozs7Ozs7O09BZ0JHO0lBQ0kscUNBQVEsR0FBZixVQUNFLE9BQTZCLEVB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dGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE2LTIwMjAgVk13YXJlLCBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBUaGlzIHNvZnR3YXJlIGlzIHJlbGVhc2VkIHVuZGVyIE1JVCBsaWNlbnNlLlxuICogVGhlIGZ1bGwgbGljZW5zZSBpbmZvcm1hdGlvbiBjYW4gYmUgZm91bmQgaW4gTElDRU5TRSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBwcm9qZWN0LlxuICovXG5cbmltcG9ydCB7IFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBOZ1pvbmUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdW5pcXVlSWRGYWN0b3J5IH0gZnJvbSAnLi4vaWQtZ2VuZXJhdG9yL2lkLWdlbmVyYXRvci5zZXJ2aWNlJztcblxuZXhwb3J0IGVudW0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzIHtcbiAgb2ZmID0gJ29mZicsXG4gIHBvbGl0ZSA9ICdwb2xpdGUnLFxuICBhc3NlcnRpdmUgPSAnYXNzZXJ0aXZlJyxcbn1cblxuLyoqXG4gKiBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgaW5zZXJ0aW5nIHRoZSBjb250ZW50IGludG8gdGhlIGNvbnRhaW5lclxuICovXG5jb25zdCBBUklBX0xJVkVfVElDSzogbnVtYmVyID0gMTAwO1xuXG4vKipcbiAqIFRoaXMgc2VydmljZSBoYW5kbGUgYGFyaWEtbGl2ZWAgYWNjZXNzaWJpbGl0eSBhdHRyaWJ1dGUuIFRoZSBpc3N1ZSBpcyB0aGF0IHlvdSBuZWVkXG4gKiB0byBoYXZlIHRoZSBET00gRWxlbWVudCB3aXRoIGF0dHJpYnV0ZSBgYXJpYS1saXZlYCBiZWZvcmUgeW91IGNvdWxkIGluc2VydCBjb250ZW50XG4gKiBhbmQgU1IgKFNjcmVlbiBSZWFkZXIpIHBpY2sgdGhlIGNoYW5nZSBhbmQgYW5ub3VuY2UgaXQuXG4gKlxuICogYGBgdHlwZXNjcmlwdFxuICogaW1wb3J0IHsgQ2xyQXJpYUxpdmVTZXJ2aWNlIH0gZnJvbSAnc3JjL2Nsci1hbmd1bGFyL3V0aWxzL2ExMXkvYXJpYS1saXZlLnNlcnZpY2UnO1xuICpcbiAqIEBDb21wb25lbnQoe1xuICogc2VsZWN0b3I6ICdjbHItZGVtby1jb21wb25lbnQnLFxuICogcHJvdmlkZXJzOiBbQ2xyQXJpYUxpdmVTZXJ2aWNlXSxcbiAqIHRlbXBsYXRlOiBgXG4gKiAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAqIGAsXG4gKiB9KVxuICogZXhwb3J0IGNsYXNzIERlbW9Db21wb25lbnQge1xuICogIGNvbnN0cnVjdG9yKGFyaWFMaXZlU2VydmljZTogQ2xyQXJpYUxpdmVTZXJ2aWNlKSB7fVxuICpcbiAqICBwdWJsaWMgYWN0aW9uVGhhdFdpbGxUcmlnZ2VyQ2hhbmdlKCkge1xuICogICAgdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UoJ21lc3NhZ2UgdGhhdCBJIHdhbnQgdG8gYW5ub3VuY2UgdG8gU1InKTtcbiAqICB9XG4gKiB9XG4gKiBgYGBcbiAqXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBDbHJBcmlhTGl2ZVNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGFyaWFMaXZlRWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50O1xuICBwcml2YXRlIHByZXZpb3VzVGltZW91dDogUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBfZG9jdW1lbnQ6IGFueSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdFxuICApIHtcbiAgICB0aGlzLmRvY3VtZW50ID0gX2RvY3VtZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBfaWQ6IHN0cmluZyA9IGBjbHItYXJpYS1saXZlLWVsZW1lbnQtJHt1bmlxdWVJZEZhY3RvcnkoKX1gO1xuICAvKipcbiAgICogZ2V0IGFjY2VzcyB0byB0aGUgaW50ZXJuYWwgSFRNTCBgaWRgIHRoYXQgZ29ubmEgYmUgdXNlZCBmb3IgdGhlIEFyaWFMaXZlIGNvbnRhaW5lci5cbiAgICogQHJldHVybiBJRCBvZiB0aGUgRE9NIEVsZW1lbnQgYXMgc3RyaW5nLlxuICAgKi9cbiAgcHVibGljIGdldCBpZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9pZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBlbmQgdGV4dCBjb250ZW50IGluc2lkZSB0aGUgQXJpYUxpdmUgQ29udGFpbmVyLiBUaGlzIG1ldGhvZCB3aWxsIGNoZWNrIGlmIHRoZVxuICAgKiBET00gRWxlbWVudCBpcyBleGlzdGluZyBpZiBub3QgaXQgd2lsbCBjcmVhdGUgb25lIGZvciB1cyBhbmQgdGhlIHdpbGwgYXBwbHkgdGhlIHRleHQuXG4gICAqXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcbiAgICogLy8gb3JcbiAgICogdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UoJ01lc3NhZ2UgdG8gYW5ub3VuY2UgdG8gU1InKTtcbiAgICogYGBgXG4gICAqXG4gICAqIEByZW1hcmtcbiAgICogV2hlbiBzZWNvbmQgYXJndW1lbnQgaXMgYEFyaWFMaXZlUG9saXRlbmVzcy5vZmZgIHdlIHdvbid0IGNyZWF0ZSBhcmlhIGNvbnRhaW5lciBvciB1cGRhdGUgaXQuXG4gICAqIFRoZSByZWFzb24gZm9yIHRoYXQgaXMgdGhhdCB3ZSBkb24ndCB3YW50IHRvIGRvIGFkZGl0aW9uYWwgd29yayBpZiB0aGUgU1Igd2lsbCBpZ25vcmUgaXQuXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIC0gVGhpcyBjb3VsZCBiZSBzaW1wbGUgc3RyaW5nIG9yIEhUTUxFbGVtZW50XG4gICAqIEBwYXJhbSBwb2xpdGVuZXNzIC0gJ3BvbGl0ZScsICdhc3NlcnRpdmUnIG9yICdvZmYnXG4gICAqL1xuICBwdWJsaWMgYW5ub3VuY2UoXG4gICAgbWVzc2FnZTogc3RyaW5nIHwgSFRNTEVsZW1lbnQsXG4gICAgcG9saXRlbmVzczogQ2xyQXJpYUxpdmVQb2xpdGVuZXNzID0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzLnBvbGl0ZVxuICApOiB2b2lkIHtcbiAgICBpZiAocG9saXRlbmVzcyA9PT0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzLm9mZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5hcmlhTGl2ZUVsZW1lbnQgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQgPSB0aGlzLmNyZWF0ZUNvbnRhaW5lcigpO1xuICAgIH1cblxuICAgIG1lc3NhZ2UgPSB0eXBlb2YgbWVzc2FnZSAhPT0gJ3N0cmluZycgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSA/IG1lc3NhZ2UudGV4dENvbnRlbnQgOiBtZXNzYWdlO1xuXG4gICAgLy8gd2hlbiB0aGVyZSBpcyBubyBtZXNzYWdlIGRvIE5PVEhJTkchXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxpdmUnLCBwb2xpdGVuZXNzKTtcblxuICAgIC8vIFRoaXMgMTAwbXMgdGltZW91dCBpcyBuZWNlc3NhcnkgZm9yIHNvbWUgYnJvd3NlciArIHNjcmVlbi1yZWFkZXIgY29tYmluYXRpb25zOlxuICAgIC8vIC0gQm90aCBKQVdTIGFuZCBOVkRBIG92ZXIgSUUxMSB3aWxsIG5vdCBhbm5vdW5jZSBhbnl0aGluZyB3aXRob3V0IGEgbm9uLXplcm8gdGltZW91dC5cbiAgICAvLyAtIFdpdGggQ2hyb21lIGFuZCBJRTExIHdpdGggTlZEQSBvciBKQVdTLCBhIHJlcGVhdGVkIChpZGVudGljYWwpIG1lc3NhZ2Ugd29uJ3QgYmUgcmVhZCBhXG4gICAgLy8gICBzZWNvbmQgdGltZSB3aXRob3V0IGNsZWFyaW5nIGFuZCB0aGVuIHVzaW5nIGEgbm9uLXplcm8gZGVsYXkuXG4gICAgLy8gKHVzaW5nIEpBV1MgMTcgYXQgdGltZSBvZiB0aGlzIHdyaXRpbmcpLlxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIC8vIFRoaXMgY2xlYXJUaW1lb3V0IHdpbGwgc3RvcCBhbGwgb2xkZXIgbWVzc2FnZXMgZnJvbSBhbm5vdW5jaW5nXG4gICAgICAvLyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgbWVzc2FnZXMgYXJlIGNvbW1pbmcgdG9vIGZhc3Qgd2UgZ29ubmEgdHJ5IHRvIGFwcGVuZCBvbmx5XG4gICAgICAvLyB0aGUgbGFzdCBvbmUuIFRoYXQncyB3aGF0IHRoZSBTUiB3aWxsIHRyeSB0byBkbyBhbnl3YXkuXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5wcmV2aW91c1RpbWVvdXQpO1xuICAgICAgdGhpcy5wcmV2aW91c1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQudGV4dENvbnRlbnQgPSA8c3RyaW5nPm1lc3NhZ2U7XG4gICAgICB9LCBBUklBX0xJVkVfVElDSyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogb25EZXN0cm95IGxpZmUgY3ljbGUgLSBtdXN0IHN0b3AgYWxsIGFjdGl2ZSBzZXRUaW1lb3V0cyBhbmQgcmVtb3ZlIHRoZSBBcmlhTGl2ZVxuICAgKiBjb250YWluZXIgZnJvbSB0aGUgZG9jdW1lbnQuXG4gICAqL1xuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMucHJldmlvdXNUaW1lb3V0KTtcbiAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSAmJiB0aGlzLmFyaWFMaXZlRWxlbWVudCkge1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJpYUxpdmVFbGVtZW50KTtcbiAgICAgIHRoaXMuYXJpYUxpdmVFbGVtZW50ID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIEFyaWFMaXZlIERPTSBlbGVtZW50IGFzIGEgbGFzdCBjaGlsZCBvZiB0aGUgZG9jdW1lbnQuXG4gICAqIEFmdGVyIHRoZSBlbGVtZW50IGlzIGNyZWF0ZWQsIHdlIGdvbm5hIGFwcGx5IENsYXJpdHkgY2xhc3MgdG8gaGlkZSBpdCBmcm9tXG4gICAqIHRoZSBzY3JlZW4gYW5kIHNldCB0aGUgYGFyaWEtbGl2ZWAgcG9saXRuZXNzLlxuICAgKlxuICAgKiBgY2xyLXNyLW9ubHlgIGlzIHRoZSBDU1MgY2xhc3MgdGhhdCBpcyB1c2VkIHRvIGhpZGUgdGhlIGVsZW1lbnQgZnJvbSB0aGUgc2NyZWVuLlxuICAgKlxuICAgKiBAcmVtYXJrXG4gICAqIENhbGxpbmcgdGhpcyBtZXRob2QgbXVsdGlwbGUgdGltZXMgd2lsbCBjcmVhdGUgbXVsdGlwbGUgRE9NIEVsZW1lbnRzLCB0aGF0XG4gICAqIHdvbid0IGJlIHRyYWNrZWQgYW5kIHdpbGwgYmUgR0MgYWZ0ZXIgdGhlIHNlcnZpY2UgaXMgZGVzdHJveWVkLlxuICAgKlxuICAgKiBAcmV0dXJuIEFyaWFMaXZlIGNvbnRhaW5lciBhcyBIVE1MRWxlbWVudFxuICAgKlxuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVDb250YWluZXIoKTogSFRNTEVsZW1lbnQge1xuICAgIGNvbnN0IGFyaWFMaXZlRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICBhcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdpZCcsIHRoaXMuaWQpO1xuICAgIC8vIFVzZSBjbGFyaXR5IHNjcmVlbiByZWFkZXIgY2xhc3MgdG8gaGlkZSB0aGUgZG9tIGVsZW1lbnRcbiAgICAvLyBhbmQgZml4IHRoZSBzY3JvbGxiYXIgc2hha2VcbiAgICBhcmlhTGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnY2xyLXNyLW9ubHknKTtcblxuICAgIGFyaWFMaXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2FyaWEtYXRvbWljJywgJ3RydWUnKTtcbiAgICBhcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxpdmUnLCBDbHJBcmlhTGl2ZVBvbGl0ZW5lc3MucG9saXRlKTtcblxuICAgIHRoaXMuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhcmlhTGl2ZUVsZW1lbnQpO1xuXG4gICAgcmV0dXJuIGFyaWFMaXZlRWxlbWVudDtcbiAgfVxufVxuIl19